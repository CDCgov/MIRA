version: "3.9"

x-spyne-git-repo:
&spyne-git-repo 
https://github.com/CDCgov/spyne.git#prod
 
x-mira-git-repo:
&mira-git-repo
https://github.com/CDCgov/MIRA.git#prod
 
x-irma-image:
&irma-image
  irma_image: cdcgov/irma:v1.2.0
 
x-dais-image:
&dais-image
  dais_image: cdcgov/dais-ribosome:v1.5.4
 
x-spyne-image:
&spyne-image
  spyne_image: cdcgov/spyne:v2.0.0  
 
x-data-volume:
&data-volume
  type: bind
  source: ~/FLU_SC2_SEQUENCING
  target: /data
 
services:
  spyne: 
    container_name: spyne
    image: *spyne-image
    build:
      context: *spyne-git-repo
      dockerfile: Dockerfile
      args:
        << : [*irma-image, *dais-image]
    restart: always
    networks:
      - frontend
    volumes:
      - *data-volume
    command: tail -f /dev/null
 
  mira:
    container_name: mira
    image: mira:latest
    build:
      context: *mira-git-repo
      dockerfile: Dockerfile
      args:
      << : [*spyne-image]
    depends_on:
      - spyne    
    restart: always
    networks:
      - frontend
      - backend
    ports:
      - 8020:8050
    volumes:
      - *data-volume
 
networks:
  backend:
    name: backend
  frontend:
    name: frontend